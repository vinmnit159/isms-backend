generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/////////////////////////
// ENUMS
/////////////////////////

enum Role {
  SUPER_ADMIN
  ORG_ADMIN
  SECURITY_OWNER
  AUDITOR
  CONTRIBUTOR
  VIEWER
}

enum AssetType {
  CLOUD
  APPLICATION
  DATABASE
  SAAS
  ENDPOINT
  NETWORK
  OTHER
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskStatus {
  OPEN
  MITIGATED
  ACCEPTED
  TRANSFERRED
}

enum ControlStatus {
  IMPLEMENTED
  PARTIALLY_IMPLEMENTED
  NOT_IMPLEMENTED
}

enum EvidenceType {
  FILE
  LINK
  SCREENSHOT
  LOG
  AUTOMATED
}

enum AuditType {
  INTERNAL
  EXTERNAL
  SURVEILLANCE
}

enum FindingSeverity {
  MINOR
  MAJOR
  OBSERVATION
}

/////////////////////////
// ORGANIZATION & USERS
/////////////////////////

model Organization {
  id          String   @id @default(uuid())
  name        String
  createdAt  DateTime @default(now())

  users       User[]
  assets      Asset[]
  controls    Control[]
  policies    Policy[]
  audits      Audit[]
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  name           String?
  role           Role
  organizationId String
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
  activityLogs   ActivityLog[]
}

/////////////////////////
// ASSET MANAGEMENT
/////////////////////////

model Asset {
  id             String   @id @default(uuid())
  name           String
  type           AssetType
  ownerId        String
  criticality    RiskLevel
  description    String?
  organizationId String
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
  risks          Risk[]
}

/////////////////////////
// RISK MANAGEMENT
/////////////////////////

model Risk {
  id          String     @id @default(uuid())
  title       String
  description String
  impact      RiskLevel
  likelihood  RiskLevel
  riskScore   Int
  status      RiskStatus
  assetId     String
  createdAt   DateTime @default(now())

  asset        Asset @relation(fields: [assetId], references: [id])
  treatments   RiskTreatment[]
}

model RiskTreatment {
  id        String @id @default(uuid())
  riskId    String
  controlId String
  notes     String?

  risk      Risk    @relation(fields: [riskId], references: [id])
  control   Control @relation(fields: [controlId], references: [id])
}

/////////////////////////
// ISO CONTROLS & SOA
/////////////////////////

model Control {
  id             String        @id @default(uuid())
  isoReference   String        // e.g. "A.5.9"
  title          String
  description    String
  status         ControlStatus
  justification  String?
  organizationId String
  createdAt      DateTime      @default(now())

  organization   Organization  @relation(fields: [organizationId], references: [id])
  evidence       Evidence[]
  riskMappings   RiskTreatment[]
  findings      AuditFinding[]
}

/////////////////////////
// EVIDENCE MANAGEMENT
/////////////////////////

model Evidence {
  id          String       @id @default(uuid())
  type        EvidenceType
  fileName    String?
  fileUrl     String?
  hash        String
  controlId   String
  collectedBy String?
  automated   Boolean      @default(false)
  createdAt   DateTime     @default(now())

  control     Control @relation(fields: [controlId], references: [id])
}

/////////////////////////
// POLICY MANAGEMENT
/////////////////////////

model Policy {
  id             String   @id @default(uuid())
  name           String
  version        String
  status         String
  documentUrl    String
  organizationId String
  approvedBy     String?
  approvedAt     DateTime?
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
}

/////////////////////////
// AUDIT MANAGEMENT
/////////////////////////

model Audit {
  id             String    @id @default(uuid())
  type           AuditType
  auditor        String
  scope          String
  startDate      DateTime
  endDate        DateTime?
  organizationId String
  createdAt      DateTime  @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
  findings       AuditFinding[]
}

model AuditFinding {
  id          String          @id @default(uuid())
  auditId    String
  controlId  String
  severity   FindingSeverity
  description String
  remediation String?
  status      String
  createdAt   DateTime        @default(now())

  audit       Audit   @relation(fields: [auditId], references: [id])
  control     Control @relation(fields: [controlId], references: [id])
}

/////////////////////////
// AUDIT LOGGING (CRITICAL)
/////////////////////////

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String
  timestamp DateTime @default(now())

  user      User @relation(fields: [userId], references: [id])
}