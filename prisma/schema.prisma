generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/////////////////////////
// ENUMS
/////////////////////////

enum Role {
  SUPER_ADMIN
  ORG_ADMIN
  SECURITY_OWNER
  AUDITOR
  CONTRIBUTOR
  VIEWER
}

enum AssetType {
  CLOUD
  APPLICATION
  DATABASE
  SAAS
  ENDPOINT
  NETWORK
  REPOSITORY
  VENDOR
  OTHER
}

enum ComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  UNKNOWN
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskStatus {
  OPEN
  MITIGATED
  ACCEPTED
  TRANSFERRED
}

enum ControlStatus {
  IMPLEMENTED
  PARTIALLY_IMPLEMENTED
  NOT_IMPLEMENTED
}

enum EvidenceType {
  FILE
  LINK
  SCREENSHOT
  LOG
  AUTOMATED
}

enum AuditType {
  INTERNAL
  EXTERNAL
  SURVEILLANCE
}

enum FindingSeverity {
  MINOR
  MAJOR
  OBSERVATION
}

/////////////////////////
// ORGANIZATION & USERS
/////////////////////////

model Organization {
  id          String   @id @default(uuid())
  name        String
  createdAt  DateTime @default(now())

  users        User[]
  assets       Asset[]
  controls     Control[]
  policies     Policy[]
  audits       Audit[]
  integrations Integration[]
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  password       String?  // nullable — Google SSO users have no password
  googleId       String?  @unique
  name           String?
  role           Role
  organizationId String
  createdAt      DateTime @default(now())

  organization   Organization    @relation(fields: [organizationId], references: [id])
  activityLogs   ActivityLog[]
  gitAccounts    UserGitAccount[]
  onboarding     UserOnboarding?
}

/////////////////////////
// SECURITY ONBOARDING
/////////////////////////

// One row per user — tracks completion of the 3 mandatory onboarding tasks.
model UserOnboarding {
  id                    String    @id @default(uuid())
  userId                String    @unique
  organizationId        String

  // Task 1: Accept all organisation policies
  policyAcceptedAt      DateTime?
  policyVersionAccepted String?   // JSON array of accepted policy ids / versions

  // Task 2: Install & enroll MDM agent
  mdmEnrolledAt         DateTime?
  deviceId              String?   // Asset id of the enrolled device

  // Task 3: Complete security awareness training video
  trainingStartedAt     DateTime?
  trainingCompletedAt   DateTime?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model UserGitAccount {
  id             String   @id @default(uuid())
  userId         String
  githubUsername String
  githubId       Int?
  avatarUrl      String?
  profileUrl     String?
  organizationId String
  createdAt      DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, githubUsername])
  @@index([userId])
}

/////////////////////////
// ASSET MANAGEMENT
/////////////////////////

model Asset {
  id             String    @id @default(uuid())
  name           String
  type           AssetType
  ownerId        String
  criticality    RiskLevel
  description    String?
  organizationId String
  // Endpoint-specific fields (populated for ENDPOINT assets managed by MDM)
  serialNumber   String?
  hostname       String?
  osType         String?   // "darwin" | "linux" | "windows"
  osVersion      String?
  status         String    @default("ACTIVE") // ACTIVE | INACTIVE | RETIRED
  createdAt      DateTime  @default(now())

  organization   Organization      @relation(fields: [organizationId], references: [id])
  risks          Risk[]
  compliance     DeviceCompliance?
  checkins       DeviceCheckin[]
  enrollment     DeviceEnrollment?
}

/////////////////////////
// MDM / DEVICE MANAGEMENT
/////////////////////////

// One-to-one: latest compliance snapshot per device
model DeviceCompliance {
  id                         String           @id @default(uuid())
  assetId                    String           @unique
  diskEncryptionEnabled      Boolean          @default(false)
  screenLockEnabled          Boolean          @default(false)
  firewallEnabled            Boolean          @default(false)
  antivirusEnabled           Boolean          @default(false)
  systemIntegrityEnabled     Boolean          @default(false)
  autoUpdateEnabled          Boolean          @default(false)
  gatekeeperEnabled          Boolean          @default(false)
  complianceStatus           ComplianceStatus @default(UNKNOWN)
  lastCheckedAt              DateTime         @default(now())

  asset  Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

// Append-only audit log of every check-in payload
model DeviceCheckin {
  id          String   @id @default(uuid())
  assetId     String
  payloadJson Json     // full posture snapshot
  receivedAt  DateTime @default(now())

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, receivedAt])
}

// Enrollment state per device
model DeviceEnrollment {
  id             String   @id @default(uuid())
  assetId        String   @unique
  apiKeyHash     String   // bcrypt hash of the issued API key
  organizationId String
  enrolledAt     DateTime @default(now())
  lastSeenAt     DateTime @default(now())
  revoked        Boolean  @default(false)

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Admin-created one-time tokens for device enrollment
model EnrollmentToken {
  id             String    @id @default(uuid())
  token          String    @unique // plain-text random token (short-lived)
  organizationId String
  createdBy      String    // userId
  label          String?   // optional friendly name e.g. "Alice's MacBook"
  usedAt         DateTime?
  expiresAt      DateTime
  createdAt      DateTime  @default(now())

  @@index([organizationId])
}

/////////////////////////
// RISK MANAGEMENT
/////////////////////////

model Risk {
  id          String     @id @default(uuid())
  title       String
  description String
  impact      RiskLevel
  likelihood  RiskLevel
  riskScore   Int
  status      RiskStatus
  assetId     String
  createdAt   DateTime @default(now())

  asset        Asset @relation(fields: [assetId], references: [id])
  treatments   RiskTreatment[]
}

model RiskTreatment {
  id        String @id @default(uuid())
  riskId    String
  controlId String
  notes     String?

  risk      Risk    @relation(fields: [riskId], references: [id])
  control     Control @relation(fields: [controlId], references: [id])
}

/////////////////////////
// ISO CONTROLS & SOA
/////////////////////////

model Control {
  id             String        @id @default(uuid())
  isoReference   String        // e.g. "A.5.9"
  title          String
  description    String
  status         ControlStatus
  justification  String?
  organizationId String
  createdAt      DateTime      @default(now())

  organization   Organization  @relation(fields: [organizationId], references: [id])
  evidence       Evidence[]
  riskMappings   RiskTreatment[]
  findings       AuditFinding[]
  testMappings   TestControl[]
}

/////////////////////////
// EVIDENCE MANAGEMENT
/////////////////////////

model Evidence {
  id          String       @id @default(uuid())
  type        EvidenceType
  fileName    String?
  fileUrl     String?
  hash        String
  controlId   String
  collectedBy String?
  automated   Boolean      @default(false)
  createdAt   DateTime     @default(now())

  control      Control        @relation(fields: [controlId], references: [id])
  testMappings TestEvidence[]
}

/////////////////////////
// POLICY MANAGEMENT
/////////////////////////

model Policy {
  id             String   @id @default(uuid())
  name           String
  version        String
  status         String
  documentUrl    String
  organizationId String
  approvedBy     String?
  approvedAt     DateTime?
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
}

/////////////////////////
// AUDIT MANAGEMENT
/////////////////////////

model Audit {
  id             String    @id @default(uuid())
  type           AuditType
  auditor        String
  scope          String
  startDate      DateTime
  endDate        DateTime?
  organizationId String
  createdAt      DateTime  @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
  findings       AuditFinding[]
  testMappings   TestAudit[]
}

model AuditFinding {
  id          String          @id @default(uuid())
  auditId    String
  controlId  String
  severity   FindingSeverity
  description String
  remediation String?
  status      String
  createdAt   DateTime        @default(now())

  audit       Audit   @relation(fields: [auditId], references: [id])
  control     Control @relation(fields: [controlId], references: [id])
}

/////////////////////////
// TEST MANAGEMENT
/////////////////////////

enum TestCategory {
  Custom
  Engineering
  HR
  IT
  Policy
  Risks
}

enum TestType {
  Document
  Automated
}

enum TestStatus {
  Due_soon       @map("Due_soon")
  Needs_remediation @map("Needs_remediation")
  OK
  Overdue
}

// Core test record
model Test {
  id              String       @id @default(uuid())
  name            String
  category        TestCategory
  ownerId         String       // FK → User.id
  type            TestType
  status          TestStatus   @default(Due_soon)
  dueDate         DateTime
  completedAt     DateTime?
  organizationId  String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Mapping relations
  controls        TestControl[]
  frameworks      TestFramework[]
  audits          TestAudit[]
  evidences       TestEvidence[]
  history         TestHistory[]

  @@index([organizationId])
  @@index([ownerId])
  @@index([status])
  @@index([dueDate])
}

// Many-to-many: Test ↔ Control
model TestControl {
  id        String @id @default(uuid())
  testId    String
  controlId String

  test      Test    @relation(fields: [testId], references: [id], onDelete: Cascade)
  control   Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([testId, controlId])
  @@index([controlId])
}

// Many-to-many: Test ↔ Framework (stored as free-text name since no Framework model exists yet)
model TestFramework {
  id            String @id @default(uuid())
  testId        String
  frameworkName String // e.g. "ISO 27001:2022", "SOC 2"

  test          Test @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([testId, frameworkName])
}

// Many-to-many: Test ↔ Audit
model TestAudit {
  id      String @id @default(uuid())
  testId  String
  auditId String

  test    Test  @relation(fields: [testId], references: [id], onDelete: Cascade)
  audit   Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@unique([testId, auditId])
  @@index([auditId])
}

// Many-to-many: Test ↔ Evidence
model TestEvidence {
  id         String @id @default(uuid())
  testId     String
  evidenceId String

  test       Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  evidence   Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  @@unique([testId, evidenceId])
}

// Immutable audit trail
model TestHistory {
  id          String   @id @default(uuid())
  testId      String
  changedBy   String   // userId
  changeType  String   // e.g. "STATUS_CHANGED", "EVIDENCE_ATTACHED", "OWNER_CHANGED", "DUE_DATE_UPDATED"
  oldValue    String?
  newValue    String?
  createdAt   DateTime @default(now())

  test        Test @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId, createdAt])
}

/////////////////////////
// INTEGRATIONS
/////////////////////////

model Integration {
  id             String    @id @default(uuid())
  organizationId String
  provider       String    // e.g. "GITHUB" | "GOOGLE_DRIVE"
  accessToken    String    // AES-256 encrypted
  refreshToken   String?   // AES-256 encrypted (Google Drive only)
  expiresAt      DateTime? // access token expiry (Google Drive only)
  metadata       Json?     // arbitrary provider data, e.g. { evidenceFolderId, policyFolderId }
  status         String    @default("ACTIVE") // ACTIVE | DISCONNECTED
  connectedBy    String    // userId
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id])
  repos          GitHubRepo[]

  @@unique([organizationId, provider])
}

model GitHubRepo {
  id              String   @id @default(uuid())
  integrationId   String
  githubId        Int
  name            String
  fullName        String
  private         Boolean
  defaultBranch   String
  visibility      String
  lastScannedAt   DateTime?
  rawData         Json?    // latest scan result
  createdAt       DateTime @default(now())

  integration     Integration @relation(fields: [integrationId], references: [id])

  @@unique([integrationId, githubId])
}

/////////////////////////
// AUDIT LOGGING (CRITICAL)
/////////////////////////

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String
  timestamp DateTime @default(now())

  user      User @relation(fields: [userId], references: [id])
}